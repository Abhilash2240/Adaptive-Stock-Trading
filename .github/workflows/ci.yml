name: CI - build

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure report directories
        run: |
          mkdir -p reports
          mkdir -p stats

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: npm audit
        run: npm audit --omit=dev

      - name: Frontend lint
        run: npm run lint

      - name: Build project
        run: npm run build

      - name: Bundle analysis
        run: npm run build:analyze

      - name: Lighthouse audit
        run: npm run lighthouse

      - name: Upload analysis artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: analysis-reports
          path: |
            reports
            stats
          if-no-files-found: ignore

      - name: Typecheck
        run: npm run check || true

      - name: Verify deploy secrets
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
        run: |
          python <<'PY'
          import json
          import os
          import sys

          required_secrets = [
              "FIREBASE_SERVICE_ACCOUNT_STAGING",
              "FIREBASE_SERVICE_ACCOUNT_PRODUCTION",
          ]

          required_vars = [
              "FIREBASE_PROJECT_ID_STAGING",
              "FIREBASE_PROJECT_ID_PRODUCTION",
              "FIREBASE_HOSTING_SITE_STAGING",
              "FIREBASE_HOSTING_SITE_PRODUCTION",
              "FIREBASE_HOSTING_CHANNEL_STAGING",
              "VITE_API_BASE_STAGING",
              "VITE_API_BASE_PRODUCTION",
              "VITE_WS_URL_STAGING",
              "VITE_WS_URL_PRODUCTION",
              "GCP_PROJECT_ID_STAGING",
              "GCP_PROJECT_ID_PRODUCTION",
              "CLOUD_RUN_REGION_STAGING",
              "CLOUD_RUN_REGION_PRODUCTION",
              "CLOUD_RUN_SERVICE_STAGING",
              "CLOUD_RUN_SERVICE_PRODUCTION",
              "CLOUD_RUN_IMAGE_STAGING",
              "CLOUD_RUN_IMAGE_PRODUCTION",
          ]

          secrets = json.loads(r'''${{ toJSON(secrets) }}''')
          vars_data = json.loads(r'''${{ toJSON(vars) }}''')

          missing = False
          for key in required_secrets:
              if not secrets.get(key):
                  print(f"::error::Missing required secret: {key}")
                  missing = True

          for key in required_vars:
              if not vars_data.get(key):
                  print(f"::error::Missing required repository variable: {key}")
                  missing = True

          if missing:
              print("Required secrets/variables are missing; aborting deploy pipeline.")
              sys.exit(1)

          env_file = os.environ.get("GITHUB_ENV")
          if env_file:
              with open(env_file, "a", encoding="utf-8") as fh:
                  fh.write(f"FIREBASE_PROJECT_ID_STAGING={vars_data.get('FIREBASE_PROJECT_ID_STAGING', '')}\n")
                  fh.write(f"FIREBASE_PROJECT_ID_PRODUCTION={vars_data.get('FIREBASE_PROJECT_ID_PRODUCTION', '')}\n")
                  fh.write(f"FIREBASE_HOSTING_SITE_STAGING={vars_data.get('FIREBASE_HOSTING_SITE_STAGING', '')}\n")
                  fh.write(f"FIREBASE_HOSTING_SITE_PRODUCTION={vars_data.get('FIREBASE_HOSTING_SITE_PRODUCTION', '')}\n")
                  fh.write(f"FIREBASE_HOSTING_CHANNEL_STAGING={vars_data.get('FIREBASE_HOSTING_CHANNEL_STAGING', '')}\n")
                  fh.write(f"GCP_PROJECT_ID_STAGING={vars_data.get('GCP_PROJECT_ID_STAGING', '')}\n")
                  fh.write(f"GCP_PROJECT_ID_PRODUCTION={vars_data.get('GCP_PROJECT_ID_PRODUCTION', '')}\n")
                  fh.write(f"CLOUD_RUN_REGION_STAGING={vars_data.get('CLOUD_RUN_REGION_STAGING', '')}\n")
                  fh.write(f"CLOUD_RUN_REGION_PRODUCTION={vars_data.get('CLOUD_RUN_REGION_PRODUCTION', '')}\n")
                  fh.write(f"CLOUD_RUN_SERVICE_STAGING={vars_data.get('CLOUD_RUN_SERVICE_STAGING', '')}\n")
                  fh.write(f"CLOUD_RUN_SERVICE_PRODUCTION={vars_data.get('CLOUD_RUN_SERVICE_PRODUCTION', '')}\n")
                  fh.write(f"CLOUD_RUN_IMAGE_STAGING={vars_data.get('CLOUD_RUN_IMAGE_STAGING', '')}\n")
                  fh.write(f"CLOUD_RUN_IMAGE_PRODUCTION={vars_data.get('CLOUD_RUN_IMAGE_PRODUCTION', '')}\n")
          PY

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install --extra-index-url https://download.pytorch.org/whl/cpu -r backend/requirements.txt
          python -m pip install pytest pytest-asyncio pip-audit bandit

      - name: Python dependency audit
        run: python -m pip_audit -r backend/requirements.txt

      - name: Bandit static analysis
        run: bandit -q -r backend -x backend/tests -c bandit.yaml

      - name: Backend tests
        run: python -m pytest backend/tests

      - name: Torch smoke test
        run: python model.py

      - name: Install gcloud CLI
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
        uses: google-github-actions/setup-gcloud@v2

      - name: Authenticate to Google Cloud (staging)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_STAGING }}'
          project_id: '${{ env.GCP_PROJECT_ID_STAGING }}'

      - name: Prepare Cloud Run manifest (staging)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          sed \
            -e "s/YOUR_GCP_PROJECT/${{ env.GCP_PROJECT_ID_STAGING }}/g" \
            -e "s/your-gcp-project/${{ env.GCP_PROJECT_ID_STAGING }}/g" \
            deploy/cloudrun/service.staging.yaml > "$RUNNER_TEMP/service.staging.yaml"

      - name: Deploy backend to Cloud Run (staging)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          gcloud run services replace "$RUNNER_TEMP/service.staging.yaml" \
            --region "${{ env.CLOUD_RUN_REGION_STAGING }}" \
            --project "${{ env.GCP_PROJECT_ID_STAGING }}" \
            --quiet

      - name: Authenticate to Google Cloud (production)
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_PRODUCTION }}'
          project_id: '${{ env.GCP_PROJECT_ID_PRODUCTION }}'

      - name: Prepare Cloud Run manifest (production)
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        run: |
          sed \
            -e "s/YOUR_GCP_PROJECT/${{ env.GCP_PROJECT_ID_PRODUCTION }}/g" \
            -e "s/your-gcp-project/${{ env.GCP_PROJECT_ID_PRODUCTION }}/g" \
            deploy/cloudrun/service.production.yaml > "$RUNNER_TEMP/service.production.yaml"

      - name: Deploy backend to Cloud Run (production)
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        run: |
          gcloud run services replace "$RUNNER_TEMP/service.production.yaml" \
            --region "${{ env.CLOUD_RUN_REGION_PRODUCTION }}" \
            --project "${{ env.GCP_PROJECT_ID_PRODUCTION }}" \
            --quiet

      - name: Set up k6
        if: github.event_name == 'push' && vars.K6_TARGET_URL != ''
        uses: grafana/setup-k6-action@v1

      - name: k6 smoke test
        if: github.event_name == 'push' && vars.K6_TARGET_URL != ''
        run: k6 run perf/k6-smoke.js
        env:
          K6_TARGET: ${{ vars.K6_TARGET_URL }}

      - name: Observability summary
        if: always()
        run: node scripts/ci/post-results.mjs

      - name: Deploy frontend to Firebase staging
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_STAGING }}'
          projectId: '${{ env.FIREBASE_PROJECT_ID_STAGING }}'
          target: '${{ env.FIREBASE_HOSTING_SITE_STAGING }}'
          channelId: '${{ env.FIREBASE_HOSTING_CHANNEL_STAGING }}'
          expires: 7d

      - name: Deploy frontend to Firebase production
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_PRODUCTION }}'
          projectId: '${{ env.FIREBASE_PROJECT_ID_PRODUCTION }}'
          target: '${{ env.FIREBASE_HOSTING_SITE_PRODUCTION }}'
          channelId: live
